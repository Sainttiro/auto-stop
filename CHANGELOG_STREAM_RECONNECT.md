# Changelog: Улучшение стабильности gRPC-потоков

**Дата:** 20.10.2025  
**Версия:** 1.1.0

## Проблема

При работе с API Tinkoff Invest возникали ошибки разрыва gRPC-соединений:
```
UNAVAILABLE Socket closed
```

Система переставала работать после 10 неудачных попыток переподключения, что приводило к полной остановке мониторинга позиций и сделок.

## Внесенные изменения

### 1. Увеличение количества попыток переподключения

**Файл:** `src/core/stream_handler.py`

**Изменения в методе `_run_trades_stream`:**
- `max_retries`: увеличено с 10 до 100
- `max_delay`: добавлено ограничение максимальной задержки в 300 секунд (5 минут)
- Экспоненциальная задержка теперь ограничена максимумом в 5 минут

**Изменения в методе `_run_positions_stream`:**
- `max_retries`: увеличено с 10 до 100
- `max_delay`: добавлено ограничение максимальной задержки в 300 секунд (5 минут)
- Экспоненциальная задержка теперь ограничена максимумом в 5 минут

### 2. Бесконечные попытки переподключения

Вместо полной остановки системы после превышения `max_retries`, система теперь:
- Логирует критическую ошибку
- Сбрасывает счетчик попыток до `max_retries - 1`
- Продолжает попытки переподключения с максимальной задержкой (5 минут)

### 3. Улучшенное логирование

Добавлена информация о текущей попытке переподключения:
```
Ошибка в потоке исполнений сделок: {e}. Повторное подключение через {delay:.1f} сек... (попытка {retry_count}/{max_retries})
```

## Технические детали

### Алгоритм задержки

```python
delay = min(retry_delay * (2 ** min(retry_count - 1, 8)), max_delay)
```

Задержки по попыткам:
- Попытка 1: 1 сек
- Попытка 2: 2 сек
- Попытка 3: 4 сек
- Попытка 4: 8 сек
- Попытка 5: 16 сек
- Попытка 6: 32 сек
- Попытка 7: 64 сек
- Попытка 8: 128 сек
- Попытка 9: 256 сек
- Попытка 10+: 300 сек (максимум)

### Логика бесконечных попыток

```python
if retry_count >= max_retries:
    logger.critical(
        f"Превышено максимальное количество попыток ({max_retries}) подключения к потоку. "
        f"Продолжаем попытки с интервалом {max_delay:.1f} сек..."
    )
    # Сбрасываем счетчик, чтобы продолжить попытки
    retry_count = max_retries - 1
```

## Преимущества

1. **Повышенная отказоустойчивость** - система не останавливается при временных проблемах с сетью
2. **Автоматическое восстановление** - при восстановлении соединения система продолжает работу
3. **Разумные задержки** - экспоненциальный рост с ограничением предотвращает перегрузку сервера
4. **Лучшая диагностика** - улучшенное логирование помогает отслеживать проблемы

## Рекомендации по мониторингу

1. Отслеживайте логи с уровнем `CRITICAL` - они указывают на длительные проблемы с подключением
2. Если видите частые переподключения, проверьте:
   - Стабильность интернет-соединения
   - Rate limits API Tinkoff
   - Нагрузку на сервер

## Совместимость

Изменения обратно совместимы и не требуют изменений в конфигурации или других частях системы.

## Тестирование

Для проверки работы системы при разрывах соединения:
1. Запустите систему
2. Временно отключите интернет
3. Проверьте логи - должны появиться сообщения о попытках переподключения
4. Восстановите интернет
5. Система должна автоматически переподключиться и продолжить работу

## Дальнейшие улучшения (опционально)

Возможные улучшения в будущем:
- Добавление метрик для мониторинга здоровья соединений
- Уведомления в Telegram при длительных проблемах с подключением
- Таймаут бездействия для принудительного переподключения
- Независимое управление потоками (один поток не влияет на другой)

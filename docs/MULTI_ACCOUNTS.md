# 🔄 Мультиаккаунты

Система Auto-Stop поддерживает работу с несколькими счетами Tinkoff с возможностью **горячего переключения без перезапуска контейнера**.

## 📋 Содержание

- [Возможности](#возможности)
- [Миграция существующих данных](#миграция-существующих-данных)
- [Управление через Telegram](#управление-через-telegram)
- [Примеры использования](#примеры-использования)
- [Технические детали](#технические-детали)

---

## ✨ Возможности

- ✅ **Несколько счетов** - добавляйте неограниченное количество счетов Tinkoff
- ✅ **Горячее переключение** - переключайтесь между счетами без перезапуска контейнера
- ✅ **Безопасное хранение** - токены хранятся в зашифрованной БД
- ✅ **Управление через Telegram** - все операции доступны через бота
- ✅ **Автоматическая миграция** - простой переход с одного счета на мультиаккаунты

---

## 🔄 Миграция существующих данных

Если вы уже используете систему с одним счетом, выполните миграцию:

### Шаг 1: Запустите скрипт миграции

```bash
# Внутри контейнера
docker compose exec auto-stop python scripts/migrate_to_multiaccounts.py

# Или локально
python scripts/migrate_to_multiaccounts.py
```

### Шаг 2: Проверьте результат

Скрипт создаст аккаунт `main` из текущего токена в `.env` и пометит его как активный.

```
✅ Миграция завершена успешно!
Создан аккаунт: main
Account ID: 2000012345
Активный: True
```

### Шаг 3: Перезапустите систему

```bash
docker compose restart
```

Теперь система будет использовать токен из БД вместо `.env`.

---

## 📱 Управление через Telegram

### Список команд

| Команда | Описание |
|---------|----------|
| `/accounts` | Список всех счетов |
| `/current_account` | Текущий активный счет |
| `/add_account` | Добавить новый счет |
| `/switch_account` | Переключить счет (без перезапуска!) |
| `/remove_account` | Удалить счет |

---

### `/accounts` - Список всех счетов

Показывает все добавленные счета с индикацией активного:

```
📊 Счета Tinkoff

🟢 main (активный)
   🆔 ID: 2000012345
   📄 Основной счет
   🕐 Последнее использование: 20.10.2025 14:30

⚪ reserve
   🆔 ID: 2000067890
   📄 Резервный счет
   🕐 Последнее использование: 15.10.2025 10:15
```

---

### `/add_account` - Добавить новый счет

**Синтаксис:**
```
/add_account <название> <токен> <account_id> [описание]
```

**Пример:**
```
/add_account reserve t.xxx...xxx 2000067890 Резервный счет
```

**Результат:**
```
✅ Аккаунт добавлен!

📝 Название: reserve
🆔 Account ID: 2000067890
📄 Описание: Резервный счет

Используйте /switch_account reserve для переключения
```

⚠️ **Важно:**
- Сообщение с токеном автоматически удаляется для безопасности
- Название должно быть уникальным
- Account ID можно узнать в личном кабинете Tinkoff

---

### `/switch_account` - Переключить счет

**Синтаксис:**
```
/switch_account <название>
```

**Пример:**
```
/switch_account reserve
```

**Процесс переключения:**

1. Система останавливает текущий stream handler
2. Закрывает соединение с API
3. Создает новое соединение с токеном нового счета
4. Переинициализирует все компоненты
5. Запускает stream handler для нового счета

**Результат:**
```
🔄 Переключаюсь на аккаунт reserve...
⏳ Переподключение к API...

✅ Переключение завершено!

🟢 Активный аккаунт: reserve
🆔 Account ID: 2000067890
📄 Описание: Резервный счет

🔄 Система работает без перезапуска!
```

⏱ **Время переключения:** ~5-10 секунд

---

### `/current_account` - Текущий активный счет

Показывает информацию о текущем активном счете:

```
🟢 Активный аккаунт

📝 Название: main
🆔 Account ID: 2000012345
📄 Описание: Основной счет
🕐 Последнее использование: 20.10.2025 14:30:45
📅 Создан: 15.10.2025 10:00
```

---

### `/remove_account` - Удалить счет

**Синтаксис:**
```
/remove_account <название>
```

**Пример:**
```
/remove_account old_account
```

⚠️ **Ограничения:**
- Нельзя удалить активный аккаунт
- Сначала переключитесь на другой аккаунт

---

## 💡 Примеры использования

### Сценарий 1: Добавление второго счета

```bash
# 1. Добавить новый счет
/add_account trading2 t.xxx...xxx 2000067890 Второй торговый счет

# 2. Проверить список счетов
/accounts

# 3. Переключиться на новый счет
/switch_account trading2

# 4. Проверить текущий счет
/current_account
```

### Сценарий 2: Переключение между счетами

```bash
# Утром - работа на основном счете
/switch_account main

# Днем - переключение на агрессивный счет
/switch_account aggressive

# Вечером - возврат на основной
/switch_account main
```

### Сценарий 3: Удаление старого счета

```bash
# 1. Переключиться на другой счет
/switch_account main

# 2. Удалить старый счет
/remove_account old_account
```

---

## 🔧 Технические детали

### Архитектура

```
┌─────────────────────────────────────────┐
│         Telegram Bot Commands           │
│  /add_account  /switch_account  etc.    │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│         Database (SQLite)               │
│  ┌───────────────────────────────────┐  │
│  │ accounts                          │  │
│  │ - id                              │  │
│  │ - name (unique)                   │  │
│  │ - token (encrypted)               │  │
│  │ - account_id                      │  │
│  │ - is_active (only one = true)     │  │
│  │ - last_used_at                    │  │
│  └───────────────────────────────────┘  │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│      AutoStopSystem.reload_api_client() │
│                                         │
│  1. Stop stream handler                │
│  2. Close current API client           │
│  3. Create new API client (new token)  │
│  4. Reinitialize components            │
│  5. Start stream handler (new account) │
└─────────────────────────────────────────┘
```

### Приоритет токенов

При запуске системы:

1. **Проверка БД** - ищет активный аккаунт в таблице `accounts`
2. **Fallback на .env** - если активный аккаунт не найден, использует `TINKOFF_TOKEN` из `.env`

```python
# Логика в main.py
active_account = await database.get_active_account()

if active_account:
    token = active_account.token
    account_id = active_account.account_id
else:
    token = config.api.token  # из .env
    account_id = config.account_id
```

### Горячее переподключение

Метод `reload_api_client()` выполняет:

```python
async def reload_api_client(self, new_account_name: str):
    # 1. Переключить в БД
    await database.switch_account(new_account_name)
    
    # 2. Получить новый аккаунт
    active_account = await database.get_active_account()
    
    # 3. Остановить stream handler
    await stream_handler.stop()
    
    # 4. Закрыть API клиент
    await api_client.__aexit__()
    
    # 5. Создать новый API клиент
    api_client = TinkoffAPIClient(token=active_account.token)
    
    # 6. Переинициализировать компоненты
    # ... instrument_cache, order_executor, strategies ...
    
    # 7. Запустить stream handler
    await stream_handler.start(active_account.account_id)
```

### Безопасность

- ✅ Токены хранятся в БД (можно добавить шифрование)
- ✅ Сообщения с токенами автоматически удаляются
- ✅ Проверка авторизации для всех команд
- ✅ Только один активный аккаунт

---

## ❓ FAQ

### Можно ли использовать систему без миграции?

Да, система работает в режиме обратной совместимости. Если в БД нет активного аккаунта, используется токен из `.env`.

### Что происходит с позициями при переключении?

Позиции хранятся в БД с привязкой к `account_id`. При переключении счета:
- Старые позиции остаются в БД
- Новый stream handler начинает отслеживать позиции нового счета

### Можно ли переключаться между счетами с открытыми позициями?

Да, но учтите:
- Система перестанет отслеживать позиции предыдущего счета
- SL/TP ордера останутся активными на бирже
- При возврате на предыдущий счет нужно будет заново синхронизировать позиции

### Сколько времени занимает переключение?

Обычно 5-10 секунд:
- Остановка stream handler: ~2 сек
- Закрытие/открытие API: ~1 сек
- Переинициализация: ~2 сек
- Запуск stream handler: ~2 сек

---

## 🚀 Roadmap

- [ ] Шифрование токенов в БД
- [ ] Автоматическое переключение по расписанию
- [ ] Статистика по каждому счету
- [ ] Экспорт/импорт конфигурации счетов
- [ ] Web-интерфейс для управления

---

## 📝 Changelog

### v1.1.0 (2025-10-20)
- ✅ Добавлена поддержка мультиаккаунтов
- ✅ Горячее переключение без перезапуска
- ✅ Команды управления в Telegram боте
- ✅ Скрипт автоматической миграции
- ✅ Приоритет токенов: БД > .env

---

## 🆘 Поддержка

Если возникли проблемы:

1. Проверьте логи: `docker compose logs -f auto-stop`
2. Используйте `/current_account` для проверки активного счета
3. Попробуйте переключиться обратно: `/switch_account main`
4. Сообщите об ошибке: `/reportbug`

---

**Документация обновлена:** 20.10.2025

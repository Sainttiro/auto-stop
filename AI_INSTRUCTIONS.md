# AI Instructions –¥–ª—è Auto-Stop

## üéØ –û –ø—Ä–æ–µ–∫—Ç–µ

Auto-Stop v2.x.x - production-—Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ø-–ª–æ—Å—Å–∞–º–∏ –∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞–º–∏ –¥–ª—è Tinkoff Invest API (gRPC).

**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ê–Ø - –æ—à–∏–±–∫–∏ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –ø–æ—Ç–µ—Ä—è–º  
**–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:** v2.2.1

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ SL/TP –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏
- ‚úÖ –ü–µ—Ä–µ—Å—á–µ—Ç —É—Ä–æ–≤–Ω–µ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –∞–∫—Ü–∏–π –∏ —Ñ—å—é—á–µ—Ä—Å–æ–≤
- ‚úÖ –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç —Å —á–∞—Å—Ç–∏—á–Ω—ã–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ –ú—É–ª—å—Ç–∏–∞–∫–∫–∞—É–Ω—Ç—ã —Å –≥–æ—Ä—è—á–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
- ‚úÖ –¢–æ—Ä–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
- `src/api/` - gRPC –∫–ª–∏–µ–Ω—Ç –¥–ª—è Tinkoff Invest API
- `src/core/` - —è–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã (–ø–æ—Ç–æ–∫–∏, –æ—Ä–¥–µ—Ä–∞, –ø–æ–∑–∏—Ü–∏–∏, —Ä–∏—Å–∫–∏)
- `src/strategies/` - —Ç–æ—Ä–≥–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- `src/storage/` - SQLite –ë–î –∏ –º–æ–¥–µ–ª–∏
- `src/bot/` - Telegram –±–æ—Ç –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
- `src/analytics/` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã
- `src/config/` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (YAML + –ë–î)
- `src/notifications/` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
- `src/utils/` - —É—Ç–∏–ª–∏—Ç—ã (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä—ã)

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ async/await
2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫** - –ë–î ‚Üí YAML ‚Üí defaults
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Ç–æ–∫–µ–Ω—ã –≤ .env, –Ω–∏–∫–æ–≥–¥–∞ –≤ –∫–æ–¥–µ
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ –ª–æ–≥–∏
5. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** - Docker –¥–ª—è –¥–µ–ø–ª–æ—è
6. **CI/CD** - GitHub Actions + Tailscale VPN

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
```
–°–æ–±—ã—Ç–∏–µ: –°–¥–µ–ª–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∞
‚Üì
Position Manager: –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏ —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É
‚Üì
Risk Calculator: –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ SL/TP
‚Üì
Order Executor: –û—Ç–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ SL/TP (–µ—Å–ª–∏ –µ—Å—Ç—å)
‚Üì
Order Executor: –í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ SL/TP
‚Üì
Database: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
‚Üì
Telegram: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

## üìê –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

### Python —Å—Ç–∏–ª—å:
- Python 3.10+ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
- PEP 8 compliance
- Type hints –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- Docstrings –¥–ª—è –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
- Async/await –¥–ª—è –≤—Å–µ—Ö I/O –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤

### Naming conventions:
- –ö–ª–∞—Å—Å—ã: `PascalCase` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `RiskCalculator`)
- –§—É–Ω–∫—Ü–∏–∏/–º–µ—Ç–æ–¥—ã: `snake_case` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `calculate_levels`)
- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã: `UPPER_SNAKE_CASE` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `MAX_RETRIES`)
- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã: `_leading_underscore`
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `snake_case`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:
```python
# Imports
import asyncio
from typing import Optional, Dict, List, Any

# Constants
MAX_RETRIES = 100

# Classes
class MyClass:
    """Docstring."""
    
    def __init__(self) -> None:
        """Initialize class."""
        self._private_var = None
    
    async def public_method(self, param: str) -> Dict[str, Any]:
        """
        Public method description.
        
        Args:
            param: Parameter description
            
        Returns:
            Dictionary with results
        """
        result = await self._private_method(param)
        return result
    
    async def _private_method(self, param: str) -> Dict[str, Any]:
        """Private method."""
        return {"result": param}
```

## üîÑ –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å

### –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:
1. –ò–∑—É—á–∏—Ç—å –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ –º–æ–¥—É–ª–∏ —á–µ—Ä–µ–∑ `map.txt`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
3. –î–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª–∏ –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å type hints –∏ docstrings
5. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã
6. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
7. –û–±–Ω–æ–≤–∏—Ç—å CHANGELOG.md —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π

### –ü—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏:
1. –ü–æ–Ω—è—Ç—å root cause
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã –ª–∏ –¥—Ä—É–≥–∏–µ —á–∞—Å—Ç–∏
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
4. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–∏–π —Ä–µ–≥—Ä–µ—Å—Å–∏—é
5. –û–±–Ω–æ–≤–∏—Ç—å CRITICAL_FIXES.md (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)
6. –û–±–Ω–æ–≤–∏—Ç—å CHANGELOG.md

### –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:
- Major (v3.0.0) - breaking changes
- Minor (v2.1.0) - –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- Patch (v2.0.1) - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã

### –ù–ï–õ–¨–ó–Ø:
- ‚ùå –ò–∑–º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ SL/TP –±–µ–∑ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –£–¥–∞–ª—è—Ç—å/–∏–∑–º–µ–Ω—è—Ç—å –ø–æ–ª—è –≤ –ë–î –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚ùå –ö–æ–º–º–∏—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- ‚ùå –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ –ø–æ—Ç–æ–∫–∞—Ö gRPC
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å hardcoded –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚ùå –ò–∑–º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —Å—É–º–º–∞—Ö
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å CHANGELOG.md
- ‚úÖ –°–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –Ω–∞—Å—Ç—Ä–æ–µ–∫: –ë–î ‚Üí YAML ‚Üí defaults

## üó∫Ô∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–æ–µ–∫—Ç—É

### –ì–¥–µ –∏—Å–∫–∞—Ç—å:
- **–†–∞—Å—á–µ—Ç SL/TP** ‚Üí `src/core/risk_calculator.py`
- **–í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤** ‚Üí `src/core/order_executor.py`
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–æ–≤** ‚Üí `src/core/stream_handler.py`
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏** ‚Üí `src/core/position_manager.py`
- **Telegram –∫–æ–º–∞–Ω–¥—ã** ‚Üí `src/bot/bot.py`
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –±–æ—Ç** ‚Üí `src/bot/settings_menu.py`
- **–ú–æ–¥–µ–ª–∏ –ë–î** ‚Üí `src/storage/models.py`
- **–†–∞–±–æ—Ç–∞ —Å –ë–î** ‚Üí `src/storage/database.py`
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** ‚Üí `src/analytics/statistics.py`
- **–û—Ç—á–µ—Ç—ã** ‚Üí `src/analytics/reports.py`

### –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `map.txt` - –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞
- `plan.txt` - –∏—Å—Ö–æ–¥–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `CHANGELOG.md` - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `docs/CRITICAL_FIXES.md` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏
- `docs/TROUBLESHOOTING.md` - —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- `docs/DEPLOYMENT.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é
- `docs/MULTI_ACCOUNTS.md` - —Ä–∞–±–æ—Ç–∞ —Å –º—É–ª—å—Ç–∏–∞–∫–∫–∞—É–Ω—Ç–∞–º–∏

## üìö –†–µ—Å—É—Ä—Å—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- **Tinkoff Invest API:** https://developer.tbank.ru/invest/api
  - –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ API
  - gRPC —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ protobuf —Å—Ö–µ–º—ã
  - –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤

- **Python SDK (invest-python):** https://developer.tbank.ru/invest/sdk/python_sdk/faq_python
  - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
  - FAQ –∏ —Ä–µ—à–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
  - Best practices –∏ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### MCP Server Context7:
- **Context7 –¥–ª—è invest-python:** https://context7.com/russianinvestments/invest-python
  - –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ò–ò –∞–≥–µ–Ω—Ç–æ–≤
  - –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API
  - –ü–æ–º–æ—â—å –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ –º–µ—Ç–æ–¥–æ–≤ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Context7:
–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Tinkoff Invest API –∏—Å–ø–æ–ª—å–∑—É–π MCP —Å–µ—Ä–≤–µ—Ä Context7 –¥–ª—è:
- –ü–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –º–µ—Ç–æ–¥–∞–º
- –ü—Ä–∏–º–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –ü–æ–Ω–∏–º–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

## üîå –†–∞–±–æ—Ç–∞ —Å MCP —Å–µ—Ä–≤–µ—Ä–∞–º–∏

### Context7 –¥–ª—è invest-python:
MCP —Å–µ—Ä–≤–µ—Ä Context7 –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ invest-python.

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –ü–æ–¥–∫–ª—é—á–∏ MCP —Å–µ—Ä–≤–µ—Ä Context7 –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Cline
2. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å API –º–µ—Ç–æ–¥–∞–º–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —á–µ—Ä–µ–∑ Context7
3. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –∏–∑ Context7 –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å

**–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Context7:**
- "–ü–æ–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è OrdersService.PostOrder"
- "–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Ç–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–π?"
- "–ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–µ—Ç–æ–¥ GetInstrumentByTicker?"

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π
- –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–¥–∞—á
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- Integration —Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –¢–µ—Å—Ç—ã –Ω–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
- –¢–µ—Å—Ç—ã –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
pytest tests/ -v --cov=src
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö:
- `CHANGELOG.md` - –≤—Å–µ–≥–¥–∞
- `README.md` - –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- `docs/CRITICAL_FIXES.md` - –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–π –±–∞–≥
- `docs/TROUBLESHOOTING.md` - –µ—Å–ª–∏ –Ω–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞
- `map.txt` - –µ—Å–ª–∏ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã

## üöÄ –î–µ–ø–ª–æ–π

### –ü—Ä–æ—Ü–µ—Å—Å:
1. Commit –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. –°–æ–∑–¥–∞—Ç—å tag –≤–µ—Ä—Å–∏–∏: `git tag v2.x.x`
3. Push: `git push origin v2.x.x`
4. GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç

### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
# –õ–æ–≥–∏
docker compose logs -f

# –°—Ç–∞—Ç—É—Å
docker compose ps

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker compose restart
```

## üí° Best Practices

1. **–í—Å–µ–≥–¥–∞ —á–∏—Ç–∞–π map.txt** –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã
2. **–ü—Ä–æ–≤–µ—Ä—è–π CRITICAL_FIXES.md** - —Ç–∞–º –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
3. **–ò—Å–ø–æ–ª—å–∑—É–π type hints** - —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
4. **–õ–æ–≥–∏—Ä—É–π –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è** - —ç—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É
5. **–¢–µ—Å—Ç–∏—Ä—É–π –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏** –ø–µ—Ä–µ–¥ production
6. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É** - –±—É–¥—É—â–∏–π —Ç—ã —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ
7. **–ò—Å–ø–æ–ª—å–∑—É–π async/await** - –≤—Å–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏
8. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏—è** - –æ—Å–æ–±–µ–Ω–Ω–æ –≤ gRPC –ø–æ—Ç–æ–∫–∞—Ö
9. **–í–∞–ª–∏–¥–∏—Ä—É–π –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –æ—Å–æ–±–µ–Ω–Ω–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
10. **–°–ª–µ–¥—É–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –Ω–∞—Å—Ç—Ä–æ–µ–∫** - –ë–î ‚Üí YAML ‚Üí defaults
11. **–ò—Å–ø–æ–ª—å–∑—É–π Context7** - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ API

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ä–µ—Å—É—Ä—Å—ã

- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** github.com/Sainttiro/auto-stop
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** docs/
- **–ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞:** map.txt
- **Tinkoff API:** https://developer.tbank.ru/invest/api
- **Python SDK:** https://developer.tbank.ru/invest/sdk/python_sdk/faq_python
- **Context7 MCP:** https://context7.com/russianinvestments/invest-python

## üìã –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### –†–∞—Å—á–µ—Ç SL/TP:
```python
async def calculate_levels(
    self,
    account_id: str,
    ticker: str,
    avg_price: float,
    quantity: int,
    direction: str
) -> Dict[str, Any]:
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —É—Ä–æ–≤–Ω–∏ SL/TP.
    
    Args:
        account_id: ID —Å—á–µ—Ç–∞
        ticker: –¢–∏–∫–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        avg_price: –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏–∏
        quantity: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ—Ç–æ–≤
        direction: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (LONG/SHORT)
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —É—Ä–æ–≤–Ω—è–º–∏ SL/TP
    """
    # –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º: –ë–î ‚Üí YAML ‚Üí defaults
    settings = await self.settings_manager.get_effective_settings(
        account_id=account_id,
        ticker=ticker
    )
    
    sl_pct = settings["stop_loss_pct"]
    tp_pct = settings["take_profit_pct"]
    
    if direction == "LONG":
        sl_price = avg_price * (1 - sl_pct / 100)
        tp_price = avg_price * (1 + tp_pct / 100)
    else:  # SHORT
        sl_price = avg_price * (1 + sl_pct / 100)
        tp_price = avg_price * (1 - tp_pct / 100)
    
    return {
        "sl_price": sl_price,
        "tp_price": tp_price,
        "settings_used": settings
    }
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π:
```python
try:
    result = await self.api_client.post_order(
        figi=figi,
        quantity=quantity,
        price=price,
        direction=direction,
        order_type=OrderType.LIMIT
    )
    logger.info(f"Order placed: {result.order_id}")
    return result
except asyncio.CancelledError:
    logger.warning("Order placement cancelled")
    raise
except Exception as e:
    logger.error(f"Failed to place order: {e}")
    # Retry logic or fallback
    return None
```

### –†–∞–±–æ—Ç–∞ —Å –ë–î:
```python
async def save_position(self, position: Position) -> None:
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ –ë–î.
    
    Args:
        position: –û–±—ä–µ–∫—Ç –ø–æ–∑–∏—Ü–∏–∏
    """
    try:
        async with self.session_maker() as session:
            async with session.begin():
                session.add(position)
                await session.commit()
        logger.info(f"Position saved: {position.ticker} {position.direction}")
    except Exception as e:
        logger.error(f"Failed to save position: {e}")
        raise
```

### Telegram –±–æ—Ç:
```python
async def cmd_status(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /status.
    
    Args:
        update: Telegram update
        context: Callback context
    """
    try:
        positions = await self.position_manager.get_open_positions()
        
        if not positions:
            await update.message.reply_text("üìä –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π")
            return
        
        message = "üìä <b>–¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏:</b>\n\n"
        
        for pos in positions:
            message += (
                f"<b>{pos.ticker}</b>: {pos.direction} {pos.quantity} –ª–æ—Ç–æ–≤\n"
                f"üí∞ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: {pos.average_price:.2f}\n"
                f"üõë –°—Ç–æ–ø-–ª–æ—Å—Å: {pos.stop_loss_price:.2f}\n"
                f"üéØ –¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç: {pos.take_profit_price:.2f}\n\n"
            )
        
        await update.message.reply_text(message, parse_mode=ParseMode.HTML)
    except Exception as e:
        logger.error(f"Error in status command: {e}")
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è invest-python —Å Context7:
```python
from tinkoff.invest import Client, OrderDirection, OrderType
from tinkoff.invest.utils import quotation_to_decimal

async def place_order_example():
    """
    –ü—Ä–∏–º–µ—Ä –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º invest-python.
    
    –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://context7.com/russianinvestments/invest-python
    """
    async with Client(token=TOKEN) as client:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ
        instrument = await client.instruments.get_instrument_by(
            id_type=InstrumentIdType.INSTRUMENT_ID_TYPE_TICKER,
            class_code="TQBR",
            id="SBER"
        )
        
        # –í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞
        order_response = await client.orders.post_order(
            instrument_id=instrument.instrument.uid,
            quantity=10,
            price=quotation_to_decimal(instrument.instrument.min_price_increment),
            direction=OrderDirection.ORDER_DIRECTION_BUY,
            account_id=ACCOUNT_ID,
            order_type=OrderType.ORDER_TYPE_LIMIT,
            order_id=str(uuid.uuid4())
        )
        
        return order_response

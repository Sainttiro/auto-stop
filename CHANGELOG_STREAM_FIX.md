# Исправление обработчиков потоков данных

## Дата: 18.10.2025

## Проблема
Система выдавала предупреждения при обработке потоков данных от Tinkoff Invest API:
1. "Получен неизвестный формат сообщения в потоке сделок"
2. "Получен неизвестный тип сообщения в потоке позиций"
3. "Получено сообщение без FIGI в потоке позиций"

## Причина
Код был написан для старой версии API и не учитывал правильную структуру ответов:
- `TradesStreamResponse` содержит вложенный объект `order_trades`, а не данные напрямую
- `PositionsStreamResponse` может содержать 4 типа сообщений: `subscriptions`, `ping`, `position`, `initial_positions`
- Обновления баланса счета (`money`) приходят без `securities` - это нормально

## Внесенные изменения

### 1. Метод `_handle_trade`

**Было:**
- Проверка `hasattr(trade_response, "order_id")` - неверно
- Прямой доступ к `trade_response.order_id`, `trade_response.figi`, etc.

**Стало:**
- Обработка `ping` сообщений (keep-alive)
- Обработка `subscription` сообщений (подтверждение подписки)
- Правильное извлечение данных из `trade_response.order_trades`
- Доступ к данным через `order_trades.order_id`, `order_trades.figi`, `order_trades.trades[0]`

### 2. Метод `_handle_position_change`

**Было:**
- Проверка только наличия `position`
- Предупреждения для всех сообщений без FIGI
- Попытка обработать обновления баланса как ошибку

**Стало:**
- Обработка `ping` сообщений (keep-alive) - DEBUG уровень
- Обработка `subscriptions` сообщений (подтверждение подписки) - INFO уровень
- Обработка `initial_positions` сообщений (начальные позиции) - INFO уровень
- Обработка обновлений баланса (`money` без `securities`) - DEBUG уровень
- Создан отдельный метод `_process_security_position` для обработки каждой позиции

### 3. Новый метод `_process_security_position`

Выделена логика обработки отдельной позиции по инструменту:
- Получение данных из `security.figi` и `security.balance`
- Проверка изменений количества
- Обновление позиции в БД
- Перевыставление ордеров SL/TP

## Улучшения логирования

- **DEBUG**: Технические сообщения (ping, пустые сообщения, обновления баланса)
- **INFO**: Важные события (подписки, изменения позиций, исполнение сделок)
- **WARNING**: Только реальные проблемы (отсутствие FIGI, дробные количества)
- **ERROR**: Ошибки обработки

## Результат

После исправлений система корректно обрабатывает все типы сообщений от API:
- ✅ Подтверждения подписки логируются как INFO
- ✅ Ping-сообщения игнорируются (DEBUG)
- ✅ Обновления баланса обрабатываются корректно (DEBUG)
- ✅ Исполнения сделок обрабатываются правильно
- ✅ Изменения позиций отслеживаются корректно
- ✅ Нет ложных предупреждений

## Тестирование

Для проверки работы:
1. Запустите систему: `python -m src.main`
2. Проверьте логи - не должно быть WARNING для штатных операций
3. Совершите тестовую сделку
4. Убедитесь, что SL/TP ордера выставляются корректно

## Дополнительные исправления (18.10.2025, 10:49)

### Проблема с выставлением SL/TP ордеров

После первых исправлений обнаружилась проблема: ордера SL/TP не выставлялись после исполнения сделок.

**Причина:**
- Отсутствовало детальное логирование для диагностики
- Возможные ошибки не логировались с полным traceback
- `trade_id` мог отсутствовать в структуре `OrderTrade`

**Исправления:**

1. **Добавлено детальное логирование** на каждом этапе обработки сделки:
   - DEBUG: Обработка сделки, определение инструмента, сохранение в БД
   - INFO: Исполнение сделки, обновление позиции, расчет уровней, выставление ордеров
   - Логирование результатов выставления ордеров (OK/FAIL)

2. **Исправлен `trade_id`:**
   - Вместо `first_trade.trade_id` (может отсутствовать)
   - Используется `f"{order_id}_{datetime.utcnow().timestamp()}"` - уникальный ID

3. **Улучшена обработка ошибок:**
   - Добавлен `exc_info=True` для полного traceback
   - Traceback сохраняется в БД для анализа

4. **Добавлены проверки на каждом этапе:**
   - Логирование после получения инструмента
   - Логирование после сохранения сделки
   - Логирование после обновления позиции
   - Логирование режима TP (обычный/многоуровневый)
   - Логирование результатов расчета уровней
   - Логирование результатов выставления ордеров

### Новые логи для диагностики

Теперь при обработке сделки вы увидите:
```
DEBUG: Обработка сделки: order_id=..., figi=..., direction=...
DEBUG: Инструмент определен: ticker=..., type=...
INFO:  Получено исполнение сделки: TICKER (FIGI), направление=..., цена=..., количество=...
DEBUG: Сделка сохранена в БД: trade_id=...
DEBUG: Обновление позиции для TICKER...
INFO:  Позиция обновлена: TICKER, количество=..., средняя цена=...
DEBUG: Настройки инструмента для TICKER: True/False
INFO:  Режим TP для TICKER: обычный/многоуровневый
DEBUG: Расчет обычных SL/TP для TICKER...
INFO:  Рассчитаны уровни: SL=..., TP=...
DEBUG: Выставление ордеров SL/TP для TICKER...
INFO:  Выставлены ордера: SL=OK/FAIL, TP=OK/FAIL
```

Это позволит точно определить, на каком этапе возникает проблема.

## Совместимость

Изменения совместимы с:
- `tinkoff-investments>=0.2.0b60`
- Текущей структурой проекта
- Существующими стратегиями и конфигурациями
